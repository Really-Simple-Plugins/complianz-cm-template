___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "categories": [
    "TAG_MANAGEMENT",
    "ADVERTISING",
    "UTILITY"
  ],
  "securityGroups": [],
  "displayName": "Complianz.io - The Privacy Suite for WordPress",
  "brand": {
    "id": "complianz",
    "displayName": "Complianz.io - The Privacy Suite for WordPress",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Consent Mode GTM Template by Complianz",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "defaultSettings2",
    "displayName": "Default Consent State",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "region",
        "displayName": "Region",
        "simpleValueType": true,
        "help": "Leave empty for the default set-up. Complianz handles regions automatically based on your wizard configuration. Check our documentation to change, if needed.",
        "valueHint": "Automated by Complianz",
        "defaultValue": ""
      },
      {
        "type": "SELECT",
        "name": "defaultConsentPreferences",
        "displayName": "Preferences (personalization_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied (Default)"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "help": "Select default consent state for preference cookies",
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "defaultConsentStatistics",
        "displayName": "Analytics (analytics_storage)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied (Default)"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "help": "Select default consent state for analytics tracking",
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "defaultConsentMarketing",
        "displayName": "Advertising (ad_storage, ad_user_data, ad_personalization)",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied (Default)"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "help": "Select default consent state for marketing and advertising",
        "defaultValue": "denied"
      },
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Redact Ads Data",
        "simpleValueType": true,
        "help": "When ad data redaction is true and marketing cookies are denied, ad click identifiers sent in network requests by Google Ads and Floodlight tags will be redacted. Network requests will also be sent through a cookieless domain"
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassthrough",
        "checkboxText": "Enable URL passthrough",
        "simpleValueType": true,
        "help": ""
      }
    ],
    "help": "A default consent state of \u0027denied\u0027 will apply until the user has submitted a consent."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// The first two lines are optional, use if you want to enable logging
const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const getCookieValues = require('getCookieValues');//permission to reach specific cookies is set
const callInWindow = require('callInWindow');//permission for each used function is set
const gtagSet = require('gtagSet'); //permission for each used key is set
const COOKIE_NAME = 'cmplz_consent_mode'; //permission for this name is set
const marketingCategories = ['ad_storage', 'ad_user_data', 'ad_personalization'];
const statisticsCategories = ['analytics_storage'];
const defaultCategories = [ 'functionality_storage','security_storage'];
const preferencesCategories = [ 'personalization_storage' ];
const allCategories = ['ad_storage','analytics_storage','functionality_storage','security_storage','personalization_storage', 'ad_user_data', 'ad_personalization'];
 log("CMV2",data);
/**
 * Splits the input string using comma as a delimiter, returning an array of
 * strings
 */
const splitInput = (input) => {
//  log('split input ', input);
	return input.split(',')
		.map(entry => entry.trim())
		.filter(entry => entry.length !== 0);
};

const defaultGrantedCategories = () => {
    let defaultSettings = data;

        let granted = defaultCategories;
        if (defaultSettings.defaultConsentMarketing === 'granted' ){
          granted = granted.concat(marketingCategories);
        }
        if (defaultSettings.defaultConsentStatistics === 'granted' ){
          granted = granted.concat(statisticsCategories);
        }
        if (defaultSettings.defaultConsentPreferences === 'granted' ){
          granted = granted.concat(preferencesCategories);
        }
  return granted;
};

const onUserRevoke = () => {
    let granted = defaultGrantedCategories();
//    log('onuser revoke',getConsentState(granted));
	onUserConsent(getConsentState(granted));
};

const onUserConsent = (consent) => {
//  log('onuser consent',consent);
	updateConsentState(consent);
};

const getConsentState = (granted) => {
  let denied = allCategories;
  let consentState = {};
  granted.forEach(entry => {
	denied = denied.filter(item => item !== entry);
	consentState[entry] = 'granted';
  });
  denied.forEach(entry => {
	consentState[entry] = 'denied';
  });
  return consentState;
};

/**
 * Executes the default command, sets the developer ID, and sets up the consent
 * update callback
 */
const main = (data) => {
//  log('loaded main');
	gtagSet(
		'developer_id.dYWVlZG', true
	);
// log('added dev id');
	
  gtagSet('ads_data_redaction', data.ads_data_redaction);
  gtagSet('url_passthrough', data.url_passthrough);
//  log('added data redaction', data.ads_data_redaction);
  
   const settings = getCookieValues(COOKIE_NAME);
    
//  log('new data', data);
//  log('cookie settings', settings);
	if (settings && settings.length>0) {
      log("found settings");
      let granted = splitInput(settings[0]);
//      log('load stored state, granted', granted);
//      log('update state', getConsentState(granted));
		onUserConsent(getConsentState(granted));
    } else {
      	//set default state
        let granted = defaultGrantedCategories();
//       log('set default state, granted', granted);
        let defaultConsent = getConsentState(granted);
//        log('defaultconsent',defaultConsent);
		//defaultConsent.wait_for_update = 500;
		setDefaultConsentState(defaultConsent);
    }

	callInWindow('addConsentUpdateListener', onUserConsent);
	callInWindow('addRevokeListener', onUserRevoke);
};
main(data);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "addConsentUpdateListener"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "addRevokeListener"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "developer_id.dYWVlZG"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "cmplz_consent_mode"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/10/2023, 16:17:32
